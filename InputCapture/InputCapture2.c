/**
 * @file InputCapture2.c
 * @author Seb Madgwick
 * @brief Input capture driver for PIC32 devices.
 */

//------------------------------------------------------------------------------
// Includes

#include "definitions.h"
#include "InputCapture2.h"
#include "Timer/Timer.h"

//------------------------------------------------------------------------------
// Variables

static void (*captureEvent)(const uint64_t ticks);

//------------------------------------------------------------------------------
// Functions

/**
 * @brief Initialises the module.
 * @param edge Edge.
 * @param captureEvent_ Capture event callback.
 */
void InputCapture2Initialise(const InputCaptureEdge edge, void (*const captureEvent_) (const uint64_t ticks)) {

    // Ensure default register states
    InputCapture2Deinitialise();

    // Configure input capture
    switch (edge) {
        case InputCaptureEdgeFalling:
            IC2CONbits.ICM = 0b010; // simple Capture Event mode - every falling edge
            break;
        case InputCaptureEdgeRising:
            IC2CONbits.ICM = 0b011; // simple Capture Event mode - every rising edge
            break;
    }
    IC2CONbits.C32 = 1;

    // Enable interrupt
    captureEvent = captureEvent_;
    EVIC_SourceEnable(INT_SOURCE_INPUT_CAPTURE_2);

    // Enable
    IC2CONbits.ON = 1;
}

/**
 * @brief Deinitialises the module.
 */
void InputCapture2Deinitialise(void) {
    IC2CON = 0;
    EVIC_SourceDisable(INT_SOURCE_INPUT_CAPTURE_2);
    EVIC_SourceStatusClear(INT_SOURCE_INPUT_CAPTURE_2);
}

/**
 * @brief Triggers a capture vent.
 */
void InputCapture2Trigger(void) {
    EVIC_SourceStatusSet(INT_SOURCE_INPUT_CAPTURE_2);
}

/**
 * @brief External interrupt handler. This function should be called by the ISR
 * implementation generated by MPLAB Harmony.
 */
void InputCapture2InterruptHandler(void) {
    uint64_t ticks = TimerGetTicks64();
    const uint32_t latency = (uint32_t) ticks - (uint32_t) IC2BUF;
    captureEvent(ticks - (uint64_t) latency);
    EVIC_SourceStatusClear(INT_SOURCE_INPUT_CAPTURE_2);
}

//------------------------------------------------------------------------------
// End of file
